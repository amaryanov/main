#!/bin/sh

#Used variables: slavedir, masterdir, host, port, user, rsync, mysqlbinlog

umask 0077

serverdir="/home/www/server/"

rsyncopt="-vrlcpz --ignore-existing --compress-level=9"

lockdircreated=0

end()
{
	echo $1
	if [ $lockdircreated = "1" ]
	then
		rmdir $mastersyncdir
	fi
	exit 1
}

counter=1
while [ "$counter" -le "$#" ]
do
	var=`eval echo '$'$counter`
	varname=`echo $var | sed 's/\([^=]\+\)=\(.*\)/\1/'`
	varval=`echo $var | sed 's/\([^=]\+\)=\(.*\)/\2/'`
	eval $varname='$varval' 2>/dev/null
	counter=`expr $counter + 1`
done

if [ "x$masterdir" = "x" ]
then
	end 'Need path to master.'
fi

if [ "x$slavedir" = "x" ]
then
	end 'Need path to slave.'
fi

mastersyncdir="$slavedir/log/mastersync"
mkdir $mastersyncdir

if [ "$?" != "0" ]
then
	end "Cant create $mastersyncdir."
fi
lockdircreated=1
trap 'end "You terminated the script."' TERM INT

if [ "x$mysqlbinlog" = "x" ]
then
	if [ -e ${serverdir}build/mysql/bin/mysqlbinlog ]
	then
		mysqlbinlog="${serverdir}build/mysql/bin/mysqlbinlog"
	elif [ "x`which mysqlbinlog`" != 'x' ]
	then
		mysqlbinlog="mysqlbinlog"
	else
		end "Need mysqlbinlog."
	fi
fi

if [ "x$rsync" = "x" ]
then
	if [ -e ${serverdir}build/rsync/bin/rsync ]
	then
		rsync="${serverdir}build/rsync/bin/rsync"
	elif [ "x`which mysqlbinlog`" != 'x' ]
	then
		rsync="rsync"
	else
		end "Need rsync."
	fi
	rsync="$rsync $rsyncopt"
fi

if [ "x$host" != "x" ]
then
	ssh="ssh"
	if [ "x$port" != "x" ]
	then
		ssh="$ssh -p$port"
	fi
	if [ "x$user" != "x" ]
	then
		ssh="$ssh -l$user"
	fi
	$rsync -e "$ssh" $host:$masterdir/log/bin/ $slavedir/masterlog/
else
	$rsync $masterdir/log/bin/ $slavedir/masterlog/
fi

if [ "$?" = "0" ]
then
	sqlfile="`mktemp -u $slavedir/sql/XXXXX`"
	for file in `find $slavedir/masterlog/ -size +0 -type f | sort`
	do
		echo $file
		$mysqlbinlog $file >> $sqlfile
		if [ "$?" != "0" ]
		then
			echo "Cant create dump from $file"
			continue
		fi
		echo -n > $file
	done
else
	end "Rsync error($?)."
fi

rmdir $mastersyncdir
exit 0

